# Account Migration

**Status:** ‚úÖ Implemented and verified (11 Jan 2026)
**Priority:** P0 (Critical feature for user adoption)

## Overview

A deploy-first approach where accounts start deactivated and are activated after importing data and updating identity.

## CLI Migration Command

The `pds migrate` command provides a delightful, whimsical UX for migrating your Bluesky account:

```bash
# Start the dev server in one terminal
pnpm dev

# Run migration in another terminal
pnpm pds migrate

# To reset and start fresh (only works on deactivated accounts)
pnpm pds migrate --clean
```

### What it does:

1. üîç Auto-detects your current PDS from your DID document
2. üì¶ Downloads your repository (posts, follows, likes)
3. üñºÔ∏è Transfers all your images
4. üìä Shows progress throughout

### Features:

- **Resumable** - Stop anytime, run again to continue
- **Non-destructive** - Only works on deactivated accounts
- **Progress tracking** - Shows exactly what's been transferred
- **Whimsical UX** - ü¶ã butterflies and "Atmosphere" references

## Core Concept: Deactivated Accounts

Instead of a complex migration wizard, we use a simple two-state model:

1. **Deactivated** - PDS is deployed, configured with DID, but not yet active
2. **Active** - Account is live, accepting writes, emitting firehose events

The "migration" is just: deploy deactivated ‚Üí import data ‚Üí activate.

## Deployment Configuration

### Required Secrets/Environment Variables

**Infrastructure (always required):**

```
PDS_HOSTNAME = "alice.example.com"
JWT_SECRET = "<random 32+ bytes>"
PASSWORD_HASH = "<bcrypt hash>"
```

**Identity:**

```
DID = "did:plc:xyz..."        # For migration: the existing DID
                               # For new account: generated by deploy script
SIGNING_KEY = "<base64 key>"   # Generated by deploy script
```

### How Configuration Works

| Value           | Set By                           | Notes                  |
| --------------- | -------------------------------- | ---------------------- |
| `PDS_HOSTNAME`  | User                             | Their domain           |
| `JWT_SECRET`    | Deploy script                    | Generated              |
| `PASSWORD_HASH` | User/script                      | From chosen password   |
| `DID`           | User (migration) or script (new) | Existing or generated  |
| `SIGNING_KEY`   | Deploy script                    | Always generated fresh |

## Account States

### Deactivated State

When deployed with a DID but not yet activated:

- ‚úÖ Serves DID document (required for PLC operations)
- ‚úÖ Accepts `importRepo` and `uploadBlob`
- ‚úÖ Read operations work (getRepo, getRecord, etc.)
- ‚ùå Write operations rejected (createRecord, etc.)
- ‚ùå Firehose does not emit events
- ‚ÑπÔ∏è `getAccountStatus` returns `active: false`

### Active State

After activation:

- ‚úÖ All operations work normally
- ‚úÖ Firehose emits events
- ‚ÑπÔ∏è `getAccountStatus` returns `active: true`

## Migration Flow

### Step 1: Deploy

```bash
# Clone/scaffold project
npx create-pds my-pds
cd my-pds

# Set secrets (DID from existing account)
wrangler secret put DID        # did:plc:xyz...
wrangler secret put PASSWORD_HASH
wrangler secret put JWT_SECRET
wrangler secret put SIGNING_KEY

# Deploy
pnpm deploy
```

PDS is now live but deactivated.

### Step 2: Export from Old PDS

```bash
# Export repository
curl -o repo.car \
  "https://bsky.social/xrpc/com.atproto.sync.getRepo?did=did:plc:xyz"

# List blobs to export
curl "https://bsky.social/xrpc/com.atproto.sync.listBlobs?did=did:plc:xyz"
```

### Step 3: Import to New PDS

```bash
# Import repository
curl -X POST \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/vnd.ipld.car" \
  --data-binary @repo.car \
  "https://alice.example.com/xrpc/com.atproto.repo.importRepo"

# Import blobs (one by one, or use bulk endpoint if available)
curl -X POST \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: image/jpeg" \
  --data-binary @blob.jpg \
  "https://alice.example.com/xrpc/com.atproto.repo.uploadBlob"
```

### Step 4: Verify Import

```bash
# Check repo was imported correctly
curl "https://alice.example.com/xrpc/com.atproto.repo.describeRepo?repo=did:plc:xyz"

# Check account status
curl "https://alice.example.com/xrpc/com.atproto.server.getAccountStatus"
# Returns: { "active": false, "imported": true, ... }
```

### Step 5: Update PLC Directory

This points your DID to the new PDS. Requires signing by old PDS via email challenge:

```bash
# Request PLC operation signature from old PDS
# (triggers email with token)
curl -X POST \
  -H "Authorization: Bearer $OLD_PDS_TOKEN" \
  "https://bsky.social/xrpc/com.atproto.identity.requestPlcOperationSignature"

# Sign operation with email token
# ... (flow TBD based on old PDS implementation)
```

### Step 6: Activate

```bash
curl -X POST \
  -H "Authorization: Bearer $TOKEN" \
  "https://alice.example.com/xrpc/com.atproto.server.activateAccount"
```

Account is now live.

## New Account Flow

For creating a fresh identity (not migration):

### Step 1: Generate Identity

```bash
# Deploy script generates DID and signing key
npx create-pds my-pds --new-account

# This:
# 1. Generates did:plc and signing keypair
# 2. Publishes DID document to PLC directory
# 3. Sets secrets in Cloudflare
# 4. Deploys the Worker
```

### Step 2: Ready to Use

Account starts active (no deactivated state needed for new accounts).

```bash
# Log in via Bluesky app or API
# Handle is your domain: @alice.example.com
```

## Endpoints Required

### All Implemented

| Endpoint                            | Notes                                            |
| ----------------------------------- | ------------------------------------------------ |
| `importRepo`                        | ‚úÖ Import CAR file                               |
| `uploadBlob`                        | ‚úÖ Upload individual blobs                       |
| `getAccountStatus`                  | ‚úÖ Returns activation state + migration progress |
| `describeRepo`                      | ‚úÖ Repository metadata                           |
| `getRepo`                           | ‚úÖ Export as CAR                                 |
| `activateAccount`                   | ‚úÖ Enable writes                                 |
| `deactivateAccount`                 | ‚úÖ Disable writes                                |
| `listMissingBlobs`                  | ‚úÖ Track blob migration progress                 |
| `gg.mk.experimental.resetMigration` | ‚úÖ Reset to start fresh (deactivated only)       |

### Not Needed

| Endpoint                | Reason                         |
| ----------------------- | ------------------------------ |
| `createAccount`         | Account created at deploy time |
| PLC operation endpoints | Handled externally via old PDS |

## Deactivation Guards

When account is deactivated, these operations should fail with error:

```typescript
// Error response for writes when deactivated
{
  "error": "AccountDeactivated",
  "message": "Account is deactivated. Call activateAccount to enable writes."
}
```

**Blocked operations:**

- `createRecord`
- `putRecord`
- `deleteRecord`
- `applyWrites`

**Allowed operations:**

- All read operations
- `importRepo`
- `uploadBlob`
- `activateAccount`

## CLI Tooling

### Implemented Commands

| Command                    | Description                                       |
| -------------------------- | ------------------------------------------------- |
| `pnpm pds init`            | Interactive setup wizard (handles migration mode) |
| `pnpm pds migrate`         | Transfer data from source PDS                     |
| `pnpm pds migrate --clean` | Reset migration and start fresh                   |
| `pnpm pds secret password` | Set account password                              |
| `pnpm pds secret jwt`      | Generate JWT secret                               |
| `pnpm pds secret key`      | Manage signing keys                               |

### Setup Flow

```bash
# Create new PDS project
npx create-pds my-pds
cd my-pds

# Interactive setup (choose "migrating existing account")
pnpm pds init

# Start dev server
pnpm dev

# Run migration (in another terminal)
pnpm pds migrate
```

## Advantages Over Complex Wizard

1. **Simpler state model** - Just active/deactivated, not a migration state machine
2. **Decoupled concerns** - Deploy is separate from migration
3. **Standard AT Protocol** - Uses existing endpoints, no custom flows
4. **Resumable** - Can stop/restart at any point
5. **Testable** - Read operations work while deactivated
6. **No staging/production split** - One deployment, two states

## References

- [Account Migration - AT Protocol](https://atproto.com/guides/account-migration)
- [PDS Migration Docs](https://github.com/bluesky-social/pds/blob/main/ACCOUNT_MIGRATION.md)
